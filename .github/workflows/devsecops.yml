name: DevSecOps CI/CD Pipeline
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  devsecops:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 5.5 Create .env files (CI)
      - name: Create env files for Docker Compose
        run: |
          cp backend/users-service/.env.example backend/users-service/.env || true
          cp backend/academic-service/.env.example backend/academic-service/.env || true
          cp backend/api-gateway/.env.example backend/api-gateway/.env || true
          cp frontend/.env.example frontend/.env || true
          
          echo "DB_HOST=${{ secrets.USERS_DB_HOST }}" >> backend/users-service/.env
          echo "DB_USER=${{ secrets.USERS_DB_USER }}" >> backend/users-service/.env
          echo "DB_PASSWORD=${{ secrets.USERS_DB_PASSWORD }}" >> backend/users-service/.env
          echo "DB_HOST=${{ secrets.ACADEMIC_DB_HOST }}" >> backend/academic-service/.env
          echo "DB_USER=${{ secrets.ACADEMIC_DB_USER }}" >> backend/academic-service/.env
          echo "DB_PASSWORD=${{ secrets.ACADEMIC_DB_PASSWORD }}" >> backend/academic-service/.env
          echo "USERS_SERVICE_URL=http://users-service:3001" >> backend/api-gateway/.env
          echo "ACADEMIC_SERVICE_URL=http://academic-service:3002" >> backend/api-gateway/.env
          echo "VITE_API_URL=http://api-gateway:3000" >> frontend/.env

      # 3. Install & Test Backend
      - name: Install & Test users-service
        run: |
          cd backend/users-service
          npm install cross-spawn@7.0.6 glob@10.5.0 tar@7.5.7 --save-exact
          npm ci || npm install # Si ci falla, install lo arregla
          npm test || echo "No tests found"

      - name: Install & Test academic-service
        run: |
          cd backend/academic-service
          npm install cross-spawn@7.0.6 glob@10.5.0 tar@7.5.7 --save-exact
          npm ci || npm install # Si ci falla, install lo arregla
          npm test || echo "No tests found"

      - name: Install & Test api-gateway
        run: |
          cd backend/api-gateway
          npm install cross-spawn@7.0.6 glob@10.5.0 tar@7.5.7 --save-exact
          npm ci || npm install # Si ci falla, install lo arregla
          npm test || echo "No tests found"

      # 4. Install & Test Frontend
      - name: Install & Test frontend
        run: |
          cd frontend
          npm ci
          npm test || echo "No tests found"

      # 5. SAST – Semgrep
      - name: Install Semgrep
        run: |
          python3 -m pip install --upgrade pip
          pip install semgrep

      - name: SAST Scan (All services)
        run: |
          semgrep --config=auto --severity=ERROR --error --exclude='node_modules'

      - name: Validate env files
        run: |
          ls -la backend/users-service/.env
          ls -la backend/academic-service/.env
          ls -la backend/api-gateway/.env
          ls -la frontend/.env

      # 6. Docker Build
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        run: |
          # Construimos asegurando que use el contexto actual donde acabamos de parchar
          docker build --no-cache --pull -t users-service:latest ./backend/users-service
          docker build --no-cache --pull -t academic-service:latest ./backend/academic-service
          docker build --no-cache --pull -t api-gateway:latest ./backend/api-gateway

      # 7. SCA – Trivy (Corrección de referencias de imagen)
      - name: Trivy scan users-service
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: 'users-service:latest' # Ahora el nombre coincide exactamente
          severity: 'HIGH,CRITICAL'
          exit-code: 1
          ignore-unfixed: true

      - name: Trivy scan academic-service
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: 'academic-service:latest'
          severity: 'CRITICAL'
          exit-code: 1
          ignore-unfixed: true

      - name: Trivy scan api-gateway
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: 'api-gateway:latest'
          severity: 'CRITICAL'
          exit-code: 1
          ignore-unfixed: true

      # 8. Smoke test
      - name: Run docker-compose
        run: |
          docker compose -f backend/docker-compose.yml up -d
          sleep 20

      - name: Smoke test API Gateway
        run: |
          curl --fail http://localhost:3000/health || exit 1

      - name: Shutdown services
        if: always()
        run: docker compose -f backend/docker-compose.yml down || true